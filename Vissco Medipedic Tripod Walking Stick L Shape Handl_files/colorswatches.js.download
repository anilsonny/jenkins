var AWColorswatchManager=Class.create();AWColorswatchManager.prototype={_updateQueue:{},initialize:function(t){this.url=t.url,this.selectorFnList=t.selectorFnList,this.productInfo={},this.data={}},addItem:function(t){var e=this,i=t.config.productId;Object.isUndefined(this.data[i])&&(this.data[i]={},this.productInfo[i]={},Event.observe(document,"dom:loaded",function(o){Object.keys(e.selectorFnList).each(function(o){e.productInfo[i][o]=e.selectorFnList[o](t.sourceEl).innerHTML})})),t.config.sortOrder=Object.values(this.data[i]).length,this.data[i][t.config.attributeId]=t},removeItem:function(t){var e=t.config.productId,i=t.config.attributeId;Object.isUndefined(this.data[e])||Object.isUndefined(this.data[e][i])||delete this.data[e][i]},getSortedProductAttributes:function(t,e){var i=Object.values(this.data[t]);if(i=i.sort(function(t,e){return t.config.sortOrder-e.config.sortOrder}),e){var o=[];return i.each(function(t){o.push(t.config.attributeId)}),o}
return i},triggerUpdate:function(t,e,i){this._recollectOptionAvailability(t,e,i);var o={};this.getSortedProductAttributes(t).each(function(t){o[t.config.attributeId]=t.getSelectedValue()}),this.getSortedProductAttributes(t).each(function(t){null!==o[t.config.attributeId]&&t.setValueInSourceEl(o[t.config.attributeId])}),this.productInfoUpdate(t)},productInfoUpdate:function(t){var e=this,i={};if(this.getSortedProductAttributes(t,!0).each(function(o){var s=e.data[t][o];null===s.getSelectedValue()?i[o]=null:i[o]=s.config.optionData[s.getSelectedValue()].products}),-1===Object.values(i).indexOf(null)){var o=null;Object.values(i).each(function(t){o=o||t,o=o.intersect(t)});var s=o.first();this._updateHTMLTo(s,t)}},_recollectOptionAvailability:function(t,e,i){var o=this.data[t][e],s=o.config.optionData[i].products,a={};Object.values(this.data[t]).each(function(t){var e=t.getSelectedValue();if(null!==e){var i=t.config.optionData[e].products;0===s.intersect(i).length?t.unselect():a[t.config.attributeId]=i}});var n=this;Object.values(this.data[t]).each(function(e){var i=null;Object.keys(a).each(function(o){var s=n.data[t][o];e.config.sortOrder<=s.config.sortOrder||(null===i&&(i=a[o]),i=i.intersect(a[o]))}),e.config.isUseSwatch&&e.items.each(function(t){var o=t.getAttribute("option-id"),s=e.config.optionData[o].products,a=(i||s).intersect(s);a.length>0?(t.show(),e.checkIsSaleable(t,a)||e.unselect(t)):t.hide()})})},_updateHTMLTo:function(t,e){var i=this,o=function(o){var s=Object.values(i.data[e]).first();Object.keys(o).each(function(t){var e=o[t],a=i.selectorFnList[t](s.sourceEl);try{a.update(e)}catch(n){console.error(n.message),a.innerHTML=e}}),i._patchForZoomers(o,t)};this._updateQueue[e]=t,Object.isUndefined(this.productInfo[t])?new Ajax.Request(this.url,{parameters:{"parts[]":Object.keys(i.selectorFnList),product_id:t},onComplete:function(s){var a=s.responseText.evalJSON();return a.success?(i.productInfo[t]=a.data,void(i._updateQueue[e]===t&&(o(i.productInfo[t]),delete i._updateQueue[e]))):void console.warn("Cannot get info for product: "+t)}}):(o(this.productInfo[t]),delete i._updateQueue[e])},_patchForZoomers:function(infoToUpdate,productId){if(!Object.isUndefined(infoToUpdate.media)){var content=infoToUpdate.media,nativeZoomerString=content.match(/new Product.Zoom\([^)]*\)/);if(nativeZoomerString){var mediaBox=this.selectorFnList.media(Object.values(this.data[productId]).first());mediaBox.select("img").first().observe("load",function(e){try{eval(nativeZoomerString[0])}catch(e){console.warn("Can not start zoomer"),console.error(e.message)}})}}}};var AWColorswatch=Class.create();AWColorswatch.prototype={alert('select');_tpl:'<div class="aw-colorswatches-attribute">{{items}}</div>',_itemTpl:'<div class="aw-colorswatches-attribute-option" option-id="{{option_id}}" title="{{title}}" sort-order="{{sort_order}}"></div>',_itemStateCSSList:{selected:"aw-colorswatches-attribute-option__state-selected",disabled:"aw-colorswatches-attribute-option__state-disabled"},_sourceAdditionalCSSClass:"aw-colorswatches-attribute-source",_labelTextCSSClass:"aw-colorswatches-attribute-label-text",_labelTextFormat:": %s",initialize:function(t){this.sourceEl=$$(t.sourceElSelector).first(),this.labelEl=(t.labelSelectFn||Prototype.emptyFunction)(this.sourceEl),this.size=t.size,this.config={productId:t.productId,attributeId:t.attributeId,isUseSwatch:t.isUseSwatch,isShowPopup:t.isShowPopup,optionData:t.optionData},AWColorswatchManagerInstance.addItem(this),this.config.isUseSwatch?this.init():this.initNativeSourceEl()},init:function(){this.sourceEl.addClassName(this._sourceAdditionalCSSClass),this._createSwatchEl(),this.sourceEl.insert({before:this.swatchEl});var t=this;t.items.each(function(e){var i=e.getAttribute("option-id");if(e.observe("click",function(o){t.onItemClick(e,i)}),t.checkIsSaleable(e,t.config.optionData[i].products),t.config.isShowPopup&&t.config.optionData[i].tooltipImg){var o=new AWColorswatchTooltip({imgSrc:t.config.optionData[i].tooltipImg,targetEl:e});e.observe("mouseover",function(t){o.show()}),e.observe("mouseout",function(t){o.hide(),o.remove()})}})},initNativeSourceEl:function(){var t=this;this.sourceEl.observe("change",function(e){var i=parseInt(t.sourceEl.getValue());AWColorswatchManagerInstance.triggerUpdate(t.config.productId,t.config.attributeId,i)})},onItemClick:function(t,e){var i=this;t.hasClassName(i._itemStateCSSList.disabled)||(i.items.each(function(t){t.removeClassName(i._itemStateCSSList.selected)}),t.addClassName(i._itemStateCSSList.selected),this._addTextToLabel(this.config.optionData[e].title),AWColorswatchManagerInstance.triggerUpdate(this.config.productId,this.config.attributeId,e))},getSelectedValue:function(){var t=null;if(!this.config.isUseSwatch)return t=parseInt(this.sourceEl.getValue()),isNaN(t)?null:t;var e=this;return e.items.each(function(i){i.hasClassName(e._itemStateCSSList.selected)&&(t=i.getAttribute("option-id"))}),t},setValueInSourceEl:function(t){if(0!==this.sourceEl.select('option[value="'+t+'"]').length&&(this.sourceEl.setValue(t),this.config.isUseSwatch))
if("createEvent"in document){var e=document.createEvent("HTMLEvents");e.initEvent("blur",!1,!0),this.sourceEl.dispatchEvent(e),e=document.createEvent("HTMLEvents"),e.initEvent("change",!1,!0),this.sourceEl.dispatchEvent(e)}else this.sourceEl.fireEvent("onblur"),this.sourceEl.fireEvent("onchange")},unselect:function(t){var e=this;this.items.each(function(i){(Object.isUndefined(t)||i.getAttribute("option-id")==t.getAttribute("option-id"))&&i.hasClassName(e._itemStateCSSList.selected)&&(i.removeClassName(e._itemStateCSSList.selected),e.setValueInSourceEl(""))})},checkIsSaleable:function(t,e){var i=this.config.optionData[t.getAttribute("option-id")].not_saleable;return e.intersect(i).length===e.length?(this.notSaleable(t),!1):(this.saleable(t),!0)},saleable:function(t){t.removeClassName(this._itemStateCSSList.disabled),t.update("")},notSaleable:function(t){t.addClassName(this._itemStateCSSList.disabled),t.update("<div></div>")},_createSwatchEl:function(){var t=this;t.items=[],Object.keys(t.config.optionData).each(function(e){var i=t.config.optionData[e];i.option_id=e,i.products.length<=0||t.items.push(t._createItemEl(i))}),t.items.sort(function(t,e){return(parseInt(t.getAttribute("sort-order"))||0)-(parseInt(e.getAttribute("sort-order"))||0)}),t.swatchEl=new Element("div"),t.swatchEl.update(t._tpl.replace(/{{items}}/g,"<span class='aw-colorswatches-attribute-items-anchor'></span>")),t.swatchEl=this.swatchEl.down();var e=t.swatchEl.select("span.aw-colorswatches-attribute-items-anchor").first();t.items.each(function(t){e.insert({before:t})}),e.remove()},_createItemEl:function(t){var e=new Element("div");return e.update(this._itemTpl.replace(/{{option_id}}/g,t.option_id).replace(/{{title}}/g,t.title).replace(/{{sort_order}}/g,t.sort_order)),e=e.down(),e.setStyle({width:this.size[0]+"px",height:this.size[1]+"px"}),t.img&&e.setStyle({backgroundImage:'url("'+t.img+'")'}),e},_addTextToLabel:function(t){if(this.labelEl){if(this.labelEl.select("."+this._labelTextCSSClass).length<=0){var e=new Element("span");e.addClassName(this._labelTextCSSClass),this.labelEl.appendChild(e)}
t=this._labelTextFormat.replace("%s",t),this.labelEl.select("."+this._labelTextCSSClass).first().update(t)}},_removeTextFromLabel:function(){if(this.labelEl){var t=this.labelEl.select("."+this._labelTextCSSClass).first();t&&t.remove()}}};var AWColorswatchTooltip=Class.create();AWColorswatchTooltip.prototype={_tpl:"<div class='aw-colorswatches-tooltip'><div class='aw-colorswatches-tooltip-content'></div><div class='aw-colorswatches-tooltip-arrow'><span class='aw-colorswatches-tooltip-arrow-border'></span><span class='aw-colorswatches-tooltip-arrow-content'></span></div></div>",_tooltipContentCSSClass:"aw-colorswatches-tooltip-content",_tooltipShowCSSClass:"aw-colorswatches-tooltip__show",_tooltipArrowCSSClass:"aw-colorswatches-tooltip-arrow",_tooltipArrowBottomOrientationCSSClass:"aw-colorswatches-tooltip-arrow__bottom",initialize:function(t){this.item=null,this.imgSrc=t.imgSrc,this.targetEl=t.targetEl},create:function(){var t=new Element("div");t.update(this._tpl),this.item=t.down();var e=new Element("img");e.setAttribute("src",this.imgSrc);var i=this;e.observe("load",function(t){i._resize()});var o=this.item.select("."+this._tooltipContentCSSClass).first();o.appendChild(e),$$("body").first().appendChild(this.item)},remove:function(){this.item.remove(),this.item=null},show:function(){this.item||this.create(),this._resize(),this.item.addClassName(this._tooltipShowCSSClass)},hide:function(){this.item&&this.item.removeClassName(this._tooltipShowCSSClass)},_resize:function(){var t=this.targetEl.cumulativeOffset(),e=this.targetEl.cumulativeScrollOffset(),i=t.left+this.targetEl.getWidth()/2-this.item.getWidth()/2,o=this.item.select("."+this._tooltipArrowCSSClass).first(),s=t.top-this.item.getHeight()-10,a=t.top-e.top-10,n=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,r=n-a-this.targetEl.getHeight()-10;a<this.item.getHeight()&&r>=this.item.getHeight()?(o.addClassName(this._tooltipArrowBottomOrientationCSSClass),s=t.top+this.targetEl.getHeight()+10):o.removeClassName(this._tooltipArrowBottomOrientationCSSClass),this.item.setStyle({left:i+"px",top:s+"px"})}};
