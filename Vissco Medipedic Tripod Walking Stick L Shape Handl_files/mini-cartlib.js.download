if(!window.Modalbox)var Modalbox=new Object;Modalbox.Methods={focusableElements:new Array,options:{title:"ModalBox Window",overlayClose:!0,width:500,height:90,overlayOpacity:.75,overlayDuration:.5,slideDownDuration:.75,slideUpDuration:.35,resizeDuration:.35,inactiveFade:!0,loadingString:"Please wait. Loading...",closeString:"Close window",params:{},method:"get"},_options:new Object,setOptions:function(t){Object.extend(this.options,t||{})},_init:function(t){Object.extend(this._options,this.options),this.setOptions(t),this.MBoverlay=Builder.node("div",{id:"MB_overlay",opacity:"0"}),this.MBwindow=Builder.node("div",{id:"MB_window",style:"display: none"},[this.MBframe=Builder.node("div",{id:"MB_frame"},[this.MBheader=Builder.node("div",{id:"MB_header"},[this.MBcaption=Builder.node("div",{id:"MB_caption"}),this.MBclose=Builder.node("a",{id:"MB_close",title:this.options.closeString,href:"#"},[Builder.build("<span>&times;</span>")])]),this.MBcontent=Builder.node("div",{id:"MB_content"},[this.MBloading=Builder.node("div",{id:"MB_loading"},this.options.loadingString)])])]),document.body.insertBefore(this.MBwindow,document.body.childNodes[0]),document.body.insertBefore(this.MBoverlay,document.body.childNodes[0]),this.initScrollX=window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft,this.initScrollY=window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop,this.hide=this.hide.bindAsEventListener(this),this.close=this._hide.bindAsEventListener(this),this.kbdHandler=this.kbdHandler.bindAsEventListener(this),this._initObservers(),this.initialized=!0,this.active=!0},show:function(t,e){this.initialized||this._init(e),this.content=t,this.setOptions(e),Element.update(this.MBcaption,this.options.title),"none"==this.MBwindow.style.display?(this._appear(),this.event("onShow")):(this._update(),this.event("onUpdate"))},hide:function(t){if(!this.initialized)throw"Modalbox isn't initialized";t&&Object.extend(this.options,t),Effect.SlideUp(this.MBwindow,{duration:this.options.slideUpDuration,afterFinish:this._deinit.bind(this)})},_hide:function(t){t&&Event.stop(t),this.hide()},_appear:function(){this._toggleSelects(),this._setOverlay(),this._setWidth(),this._setPosition(),new Effect.Fade(this.MBoverlay,{from:0,to:this.options.overlayOpacity,duration:this.options.overlayDuration,afterFinish:function(){new Effect.SlideDown(this.MBwindow,{duration:this.options.slideDownDuration,afterFinish:function(){this._setPosition(),this.loadContent()}.bind(this)})}.bind(this)}),this._setWidthAndPosition=this._setWidthAndPosition.bindAsEventListener(this),Event.observe(window,"resize",this._setWidthAndPosition)},resize:function(t,e,i){var s=Element.getHeight(this.MBwindow),n=Element.getHeight(this.MBheader),o=Element.getHeight(this.MBcontent),h=o>s-n+e?o+n-s:e;this.setOptions(i),new Effect.ScaleBy(this.MBwindow,t,h,{duration:this.options.resizeDuration,afterFinish:function(){this.event("afterResize")}.bind(this)})},_update:function(){this.currentDims=[this.MBwindow.offsetWidth,this.MBwindow.offsetHeight],this.options.width+10!=this.currentDims[0]||this.options.height+5!=this.currentDims[1]?new Effect.ScaleBy(this.MBwindow,this.options.width-this.currentDims[0],this.options.height-this.currentDims[1],{duration:this.options.resizeDuration,afterFinish:this._loadAfterResize.bind(this),beforeStart:function(t){Element.update(this.MBcontent,""),this.MBcontent.appendChild(this.MBloading),Element.update(this.MBloading,this.options.loadingString)}.bind(this)}):(Element.update(this.MBcontent,""),this.MBcontent.appendChild(this.MBloading),Element.update(this.MBloading,this.options.loadingString),this._loadAfterResize())},loadContent:function(){if(0!=this.event("beforeLoad"))if("string"==typeof this.content){var htmlRegExp=new RegExp(/<\/?[^>]+>/gi);htmlRegExp.test(this.content)?this._insertContent(this.content):new Ajax.Request(this.content,{method:this.options.method.toLowerCase(),parameters:this.options.params,onComplete:function(transport){var response=new String(transport.responseText);response.extractScripts().map(function(script){return eval(script.replace("<!--","").replace("// -->",""))}.bind(window)),this._insertContent(transport.responseText.stripScripts())}.bind(this)})}else{if("object"!=typeof this.content)throw Modalbox.hide(),"Please specify correct URL or HTML element (plain HTML or object)";this._insertContent(this.content)}},_insertContent:function(t){if(Element.extend(this.MBcontent),this.MBcontent.update(""),"string"==typeof t)this.MBcontent.hide().update(t);else if("object"==typeof this.content){var e=t.cloneNode(!0);this.content.id&&(e.id="MB_"+e.id),this.MBcontent.hide().appendChild(e),this.MBcontent.down().show()}this.options.height==this._options.height?Modalbox.resize(0,this.MBcontent.getHeight()-Element.getHeight(this.MBwindow)+Element.getHeight(this.MBheader),{afterResize:function(){this.MBcontent.show(),this.focusableElements=this._findFocusableElements(),this._moveFocus(),this.event("afterLoad")}.bind(this)}):(this._setWidth(),this.MBcontent.setStyle({overflow:"auto",height:Element.getHeight(this.MBwindow)-Element.getHeight(this.MBheader)-11+"px"}),this.MBcontent.show(),this.focusableElements=this._findFocusableElements(),this._moveFocus(),this.event("afterLoad"))},activate:function(t){this.setOptions(t),this.active=!0,Event.observe(this.MBclose,"click",this.close),this.options.overlayClose&&Event.observe(this.MBoverlay,"click",this.hide),Element.show(this.MBclose),this.options.inactiveFade&&new Effect.Appear(this.MBwindow,{duration:this.options.slideDownDuration})},deactivate:function(t){this.setOptions(t),this.active=!1,Event.stopObserving(this.MBclose,"click",this.close),this.options.overlayClose&&Event.stopObserving(this.MBoverlay,"click",this.hide),Element.hide(this.MBclose),this.options.inactiveFade&&new Effect.Fade(this.MBwindow,{duration:this.options.slideUpDuration,to:.75})},_initObservers:function(){Event.observe(this.MBclose,"click",this.close),this.options.overlayClose&&Event.observe(this.MBoverlay,"click",this.hide),Event.observe(document,"keypress",Modalbox.kbdHandler)},_removeObservers:function(){Event.stopObserving(this.MBclose,"click",this.close),this.options.overlayClose&&Event.stopObserving(this.MBoverlay,"click",this.hide),Event.stopObserving(document,"keypress",Modalbox.kbdHandler)},_loadAfterResize:function(){this._setWidth(),this._setPosition(),this.loadContent()},_moveFocus:function(){this.focusableElements.length>0?this.focusableElements.first().focus():$("MB_close").focus()},_findFocusableElements:function(){return $A($("MB_content").descendants()).findAll(function(t){return["INPUT","TEXTAREA","SELECT","A","BUTTON"].include(t.tagName)})},kbdHandler:function(t){var e=Event.element(t);switch(t.keyCode){case Event.KEY_TAB:Event.element(t)==this.focusableElements.last()&&(Event.stop(t),this._moveFocus());break;case Event.KEY_ESC:this.active&&this._hide(t);break;case 32:this._preventScroll(t);break;case 0:32==t.which&&this._preventScroll(t);break;case Event.KEY_UP:case Event.KEY_DOWN:case Event.KEY_PAGEDOWN:case Event.KEY_PAGEUP:case Event.KEY_HOME:case Event.KEY_END:/Safari|KHTML/.test(navigator.userAgent)&&!["textarea","select"].include(e.tagName.toLowerCase())?Event.stop(t):("input"==e.tagName.toLowerCase()&&["submit","button"].include(e.type)||"a"==e.tagName.toLowerCase())&&Event.stop(t)}},_preventScroll:function(t){["input","textarea","select","button"].include(Event.element(t).tagName.toLowerCase())||Event.stop(t)},_deinit:function(){this._toggleSelects(),this._removeObservers(),Event.stopObserving(window,"resize",this._setWidthAndPosition),Effect.toggle(this.MBoverlay,"appear",{duration:this.options.overlayDuration,afterFinish:this._removeElements.bind(this)}),Element.setStyle(this.MBcontent,{overflow:"",height:""})},_removeElements:function(){navigator.appVersion.match(/\bMSIE\b/)&&(this._prepareIE("",""),window.scrollTo(this.initScrollX,this.initScrollY)),Element.remove(this.MBoverlay),Element.remove(this.MBwindow),this.initialized=!1,this.event("afterHide"),this.setOptions(this._options)},_setOverlay:function(){navigator.appVersion.match(/\bMSIE\b/)&&(this._prepareIE("100%","hidden"),navigator.appVersion.match(/\b7.0\b/)||window.scrollTo(0,0))},_setWidth:function(){Element.setStyle(this.MBwindow,{width:this.options.width+"px",height:this.options.height+"px"})},_setPosition:function(){this.MBwindow.style.left=Math.round((Element.getWidth(document.body)-Element.getWidth(this.MBwindow))/2)+"px"},_setWidthAndPosition:function(){this._setWidth(),this._setPosition()},_getScrollTop:function(){var t;return document.documentElement&&document.documentElement.scrollTop?t=document.documentElement.scrollTop:document.body&&(t=document.body.scrollTop),t},_prepareIE:function(t,e){var i=document.getElementsByTagName("body")[0];i.style.height=t,i.style.overflow=e;var s=document.getElementsByTagName("html")[0];s.style.height=t,s.style.overflow=e},_toggleSelects:function(){navigator.appVersion.match(/\bMSIE\b/)&&$$("select").each(function(t){t.style.visibility=""==t.style.visibility?"hidden":""})},event:function(t){if(this.options[t]){var e=this.options[t]();return this.options[t]=null,void 0!=e?e:!0}return!0}},Object.extend(Modalbox,Modalbox.Methods),Effect.ScaleBy=Class.create(),Object.extend(Object.extend(Effect.ScaleBy.prototype,Effect.Base.prototype),{initialize:function(t,e,i,s){this.element=$(t);var s=Object.extend({scaleFromTop:!0,scaleMode:"box",scaleByWidth:e,scaleByHeight:i},arguments[3]||{});this.start(s)},setup:function(){this.elementPositioning=this.element.getStyle("position"),this.originalTop=this.element.offsetTop,this.originalLeft=this.element.offsetLeft,this.dims=null,"box"==this.options.scaleMode&&(this.dims=[this.element.offsetHeight,this.element.offsetWidth]),/^content/.test(this.options.scaleMode)&&(this.dims=[this.element.scrollHeight,this.element.scrollWidth]),this.dims||(this.dims=[this.options.scaleMode.originalHeight,this.options.scaleMode.originalWidth]),this.deltaY=this.options.scaleByHeight,this.deltaX=this.options.scaleByWidth},update:function(t){var e=this.dims[0]+this.deltaY*t,i=this.dims[1]+this.deltaX*t;this.setDimensions(e,i)},setDimensions:function(t,e){var i={};i.width=e+"px",i.height=t+"px";var s=Math.round((t-this.dims[0])/2),n=Math.round((e-this.dims[1])/2);"absolute"==this.elementPositioning||"fixed"==this.elementPositioning?(this.options.scaleFromTop||(i.top=this.originalTop-s+"px"),i.left=this.originalLeft-n+"px"):(this.options.scaleFromTop||(i.top=-s+"px"),i.left=-n+"px"),this.element.setStyle(i)}});